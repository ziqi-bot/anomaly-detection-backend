const express = require('express');
const bodyParser = require('body-parser');
const multer = require('multer');
const cors = require('cors');  // 导入 cors
const path = require('path');
const fs = require('fs');  // Node.js file system module

const app = express();
const PORT = process.env.PORT || 5000;

// Define storage configuration for multer
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        // Set the destination folder where files will be stored
        cb(null, './uploads');  // './uploads' is the directory where files will be saved
    },
    filename: function (req, file, cb) {
        // Set the file name of the uploaded files
        cb(null, Date.now() + '-' + file.originalname);
    }
});

const upload = multer({ storage: storage });

// 使用 body-parser 中间件解析 JSON 请求
app.use(bodyParser.json());

// 启用 CORS 中间件
app.use(cors());

// Root route to handle GET request
app.get('/', (req, res) => {
    res.send('Welcome to the video upload server');
});

// 处理 /favicon.ico 请求，避免 404 错误
app.get('/favicon.ico', (req, res) => res.status(204).end());

// 处理视频上传的 POST 请求
app.post('/api/uploadVideo', upload.single('video'), (req, res) => {
    if (!req.file) {
        return res.status(400).json({ error: 'No file uploaded' });
    }

    console.log('Received file:', req.file);
    res.status(200).json({ message: 'File uploaded successfully', file: req.file });
});

// 启动服务器
app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
